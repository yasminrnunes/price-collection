// Use DBML to define your database structure
// Docs: https://dbml.dbdiagram.io/docs

Table prices {
  id serial [primary key]
  id_supermarket integer
  id_product integer
  extraction_date timestamp
  value int
  currency varchar
  
  indexes {
    (id_supermarket, id_product, extraction_date) [unique]  // 游댐 unique constraint
  }
}

Table discounts {
  id serial [primary key]
  id_price integer [ref: > prices.id]
  unit_value int
  condition_type varchar
  min_qty int
  multiple_qty int
}

Table supermarkets {
  id serial [primary key]
  name varchar
  logo varchar
}

Table products {
  id serial [primary key]
  name varchar
  normalized_name varchar
  quantity decimal(8,2)
  id_unit integer
  id_brand integer
  category varchar
  variety varchar
  presentation varchar // pack, bolsa, botella
  //description_original varchar -> esta info ya estar치 en la tabla de trazabilidad
  // de producto, adem치s un producto en esta tabla puede tener diferentes nombres 
  // en diferentes supermercados
}

Table units_of_measurement {
  id serial [primary key]
  name varchar //kg, unidade, pacote
  type varchar //opcional peso, cantidad 
  //description_original varchar -> esta info ya estar치 en la tabla de trazabilidad
  // de producto, adem치s un producto en esta tabla puede tener diferentes nombres 
  // en diferentes supermercados
}

Table raw_product_data {
  original_name varchar [primary key]
  product_url varchar  [primary key]
  product_id integer
  extraction_date timestamp
  market varchar
}

Table brands{
  id serial [primary key]
  name varchar
  normalized_name varchar
  is_private_label boolean //indica si la marca es blanca o no
}

Table stage_scraping_products{
  id bigint [primary key]
  name varchar [not null]
  market varchar
  category varchar
  brand varchar
  product_url varchar
  source_id varchar [note: 'product id in the market']
  price int [not null]
  quantity decimal(8,2) [note: 'quantity per unit of measure']
  unit_of_measure varchar [note: 'KG, UNIT, LITER, ETC.']  
  extraction_url text [note: 'URL where it was scraped']
  extraction_date timestamp [not null]
  currency varchar
  created_at timestamp [default: 'now()']
  is_processed boolean [default: FALSE]
}

Table stage_discounts {
  id bigint [primary key]
  product_id bigint [ref: > stage_scraping_products.id, not null]
  type varchar [not null, note: 'PERCENTAGE_QUANTITY, CARD, WHOLESALE, BUY_X_GET_Y']
  discounted_price int [not null]

  conditions_text varchar [note: 'human readable conditions']

  // PERCENTAGE_QUANTITY (-40% na 2춹 unidade)
  // WHOLESALE (apartir de 3 unidades)
  conditions_min_quantity integer [note: 'minimum quantity to apply the discount']

  // BUY_X_GET_Y (2x1, 3x2)
  conditions_buy_quantity integer [note: 'quantity to buy to apply the discount']
  conditions_get_quantity integer [note: 'quantity to get to apply the discount']

  created_at timestamp [default: 'now()']
}

Ref product_price: prices.id_product > products.id // many-to-one
Ref supermarket_price: prices.id_supermarket > supermarkets.id // many-to-one
Ref brand_product: products.id_brand > brands.id
Ref unit_product: products.id_unit > units_of_measurement.id
Ref stage_product: stage_scraping_products.id < stage_discounts.id
Ref raw_product: raw_product_data.product_id < products.id
// Tambi칠n habr치 una tabla que es la que ser치 rellenada con el web scrapping (7 super)
// y luego con el procesamiento ya se rellenar치n esas otras tablas.

// DUDAS:
// Como pondr칤a los packs de los productos?
// pack de 4 botellas de 2l

// PROCESAMIENTO
// Normalizaci칩n de las unidades
//    El mismo producto puede estar en ml y otros en litros
// Normalizaci칩n de los nombres de los productos
//    En el mismo supermercado, pueden haber marcas registradas de diferentes maneras,
//  con espacio al final, sin y con acento --> Fort Atacadista (Uni칚o , Uni칚o, Caravelas,
//  Caravellas)

// ARROZ AGULHINHA TIPO 1 TIO JO츾O
//   1 KG:
// - Arroz Agulhinha Tipo 1 TIO JO츾O Pacote 1kg
// - Arroz Polido Tio Jo칚o Tipo 1 Com 1kg
// - Arroz Tipo 1 Tio Jo칚o 1Kg
// - Arroz Branco Tio Jo칚o 1Kg
// - Arroz Polido Tipo 1 Tio Jo칚o 1kg

//    2 KG:

//    5 KG:
// - Arroz Tio Jo칚o 100% Gr칚os Nobres 5Kg

